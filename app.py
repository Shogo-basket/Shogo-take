# -*- coding: utf-8 -*-
"""mosaic art.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1w0PqXF5sllidJeWknCZHHw7XQ-8WysEz
"""

import streamlit as st
from PIL import Image, ImageDraw, ImageFont
import numpy as np
import io
import pandas as pd
import zipfile

# --- å®šæ•°ã¨ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•° ---
MM_PER_INCH = 25.4 # 1ã‚¤ãƒ³ãƒã‚ãŸã‚Šã®ãƒŸãƒªãƒ¡ãƒ¼ãƒˆãƒ«æ•°

def hex_to_rgb(hex_color):
    """16é€²æ•°ã‚«ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰ã‚’RGBã‚¿ãƒ—ãƒ«ã«å¤‰æ›ã—ã¾ã™ã€‚"""
    hex_color = hex_color.lstrip('#')
    return tuple(int(hex_color[i:i+2], 16) for i in (0, 2, 4))

# --- ãƒ¢ã‚¶ã‚¤ã‚¯ã‚¢ãƒ¼ãƒˆç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯ (å¤‰æ›´ãªã—) ---
def generate_mosaic_art(original_image_pil, num_mosaics_horizontal, num_mosaics_vertical, sticker_colors_data):
    """
    ãƒ¢ã‚¶ã‚¤ã‚¯ã‚¢ãƒ¼ãƒˆã‚’ç”Ÿæˆã—ã€ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»åƒã¨é…ç½®æƒ…å ±ã‚’è¿”ã—ã¾ã™ã€‚
    ã“ã®é–¢æ•°ã§ã¯ã€å…ƒç”»åƒã‚’å˜ç´”ã«æŒ‡å®šã•ã‚ŒãŸãƒ¢ã‚¶ã‚¤ã‚¯ç·æ•°ã§å‰²ã£ãŸãƒ”ã‚¯ã‚»ãƒ«ã«ãƒªã‚µã‚¤ã‚ºã—ã¾ã™ã€‚
    æœ€çµ‚çš„ãªå°åˆ·æ™‚ã®ãƒ”ã‚¯ã‚»ãƒ«ã‚µã‚¤ã‚ºã¯split_mosaic_into_sheetsã§èª¿æ•´ã•ã‚Œã¾ã™ã€‚

    Args:
        original_image_pil (PIL.Image.Image): å…ƒç”»åƒã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã€‚
        num_mosaics_horizontal (int): æ¨ªæ–¹å‘ã®ãƒ¢ã‚¶ã‚¤ã‚¯ç·æ•°ã€‚
        num_mosaics_vertical (int): ç¸¦æ–¹å‘ã®ãƒ¢ã‚¶ã‚¤ã‚¯ç·æ•°ã€‚
        sticker_colors_data (list): ä½¿ç”¨ã™ã‚‹ã‚·ãƒ¼ãƒ«ã®è‰²ãƒ‡ãƒ¼ã‚¿ãƒªã‚¹ãƒˆ [(RGBã‚¿ãƒ—ãƒ«, è‰²å), ...]ã€‚

    Returns:
        tuple: (PIL.Image.Image, list) -> ãƒ¢ã‚¶ã‚¤ã‚¯ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»åƒ, é…ç½®æƒ…å ±ãƒªã‚¹ãƒˆ
    """
    if not sticker_colors_data:
        st.warning("ã‚·ãƒ¼ãƒ«è‰²ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚")
        return None, None

    sticker_rgb_only = [item[0] for item in sticker_colors_data]

    if original_image_pil.mode != 'RGB':
        original_image_pil = original_image_pil.convert("RGB")

    # å„ãƒ¢ã‚¶ã‚¤ã‚¯ã®ãƒ”ã‚¯ã‚»ãƒ«ã‚µã‚¤ã‚ºã‚’è¨ˆç®—
    mosaic_width_px = original_image_pil.width // num_mosaics_horizontal
    mosaic_height_px = original_image_pil.height // num_mosaics_vertical

    # ãƒªã‚µã‚¤ã‚ºå¾Œã®ç”»åƒã‚µã‚¤ã‚º (ä½™ã‚Šã¯åˆ‡ã‚Šæ¨ã¦)
    resized_width = mosaic_width_px * num_mosaics_horizontal
    resized_height = mosaic_height_px * num_mosaics_vertical

    if resized_width == 0 or resized_height == 0:
        st.error("ãƒ¢ã‚¶ã‚¤ã‚¯ã®ãƒ”ã‚¯ã‚»ãƒ«ã‚µã‚¤ã‚ºãŒå°ã•ã™ãã¾ã™ã€‚å…ƒç”»åƒã¾ãŸã¯ãƒ¢ã‚¶ã‚¤ã‚¯æ•°ã‚’èª¿æ•´ã—ã¦ãã ã•ã„ã€‚")
        return None, None

    resized_image = original_image_pil.resize((resized_width, resized_height), Image.LANCZOS)

    sticker_colors_np = np.array(sticker_rgb_only)

    mosaic_preview_image = Image.new("RGB", resized_image.size)
    pixels_preview = mosaic_preview_image.load()

    mosaic_placement_data = []
    mosaic_placement_data.append(["Row", "Column", "Assigned Color Index", "Assigned Color Name", "Assigned Color (RGB)"])

    progress_text = "ãƒ¢ã‚¶ã‚¤ã‚¯ç”Ÿæˆä¸­..."
    my_bar = st.progress(0, text=progress_text)

    total_cells = num_mosaics_horizontal * num_mosaics_vertical
    completed_cells = 0

    for r in range(num_mosaics_vertical):
        for c in range(num_mosaics_horizontal):
            left = c * mosaic_width_px
            top = r * mosaic_height_px
            right = left + mosaic_width_px
            bottom = top + mosaic_height_px

            mosaic_region = resized_image.crop((left, top, right, bottom))
            avg_color = np.array(mosaic_region).mean(axis=(0, 1))

            distances = np.sqrt(np.sum((sticker_colors_np - avg_color)**2, axis=1))
            closest_color_index = np.argmin(distances)

            assigned_rgb = sticker_colors_data[closest_color_index][0]
            assigned_name = sticker_colors_data[closest_color_index][1]

            for x in range(left, right):
                for y in range(top, bottom):
                    pixels_preview[x, y] = assigned_rgb

            mosaic_placement_data.append([r + 1, c + 1, closest_color_index + 1, assigned_name, assigned_rgb])

            completed_cells += 1
            my_bar.progress(completed_cells / total_cells, text=progress_text)

    my_bar.empty()

    return mosaic_preview_image, mosaic_placement_data

# --- ã‚·ãƒ¼ãƒˆåˆ†å‰²ãƒ­ã‚¸ãƒƒã‚¯ (å¤‰æ›´ãªã—) ---
def split_mosaic_into_sheets(full_mosaic_image, full_placement_data,
                             num_sheets_horizontal, num_sheets_vertical,
                             sheet_width_mm, sheet_height_mm, target_dpi,
                             margin_top_mm, margin_bottom_mm, margin_left_mm, margin_right_mm):
    """
    ç”Ÿæˆã•ã‚ŒãŸãƒ¢ã‚¶ã‚¤ã‚¯ã‚¢ãƒ¼ãƒˆã‚’è¤‡æ•°ã®ã‚·ãƒ¼ãƒˆã«åˆ†å‰²ã—ã€å„ãƒã‚¹ã«è‰²æƒ…å ±ã‚’æ›¸ãè¾¼ã¿ã¾ã™ã€‚
    ã‚·ãƒ¼ãƒˆã®ç‰©ç†ã‚µã‚¤ã‚ºã€DPIã€ãŠã‚ˆã³ä½™ç™½ã‚’è€ƒæ…®ã—ã¦ã€å„ã‚·ãƒ¼ãƒˆã®ãƒ”ã‚¯ã‚»ãƒ«ã‚µã‚¤ã‚ºã¨æç”»é ˜åŸŸã‚’æ±ºå®šã—ã¾ã™ã€‚

    Args:
        full_mosaic_image (PIL.Image.Image): å…¨ä½“ã®ãƒ¢ã‚¶ã‚¤ã‚¯ã‚¢ãƒ¼ãƒˆç”»åƒã€‚
        full_placement_data (list): å…¨ä½“ã®ãƒ¢ã‚¶ã‚¤ã‚¯é…ç½®æƒ…å ± (è‰²ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã€è‰²åã€RGBã‚’å«ã‚€)ã€‚
        num_sheets_horizontal (int): æ¨ªæ–¹å‘ã®ã‚·ãƒ¼ãƒˆåˆ†å‰²æ•°ã€‚
        num_sheets_vertical (int): ç¸¦æ–¹å‘ã®ã‚·ãƒ¼ãƒˆåˆ†å‰²æ•°ã€‚
        sheet_width_mm (float): 1æšã®ã‚·ãƒ¼ãƒˆã®å¹… (ãƒŸãƒªãƒ¡ãƒ¼ãƒˆãƒ«)ã€‚
        sheet_height_mm (float): 1æšã®ã‚·ãƒ¼ãƒˆã®é«˜ã• (ãƒŸãƒªãƒ¡ãƒ¼ãƒˆãƒ«)ã€‚
        target_dpi (int): æœ€çµ‚çš„ãªå°åˆ·æ™‚ã®ç›®æ¨™DPI (Dots Per Inch)ã€‚
        margin_top_mm (float): ä¸Šä½™ç™½ (mm)ã€‚
        margin_bottom_mm (float): ä¸‹ä½™ç™½ (mm)ã€‚
        margin_left_mm (float): å·¦ä½™ç™½ (mm)ã€‚
        margin_right_mm (float): å³ä½™ç™½ (mm)ã€‚

    Returns:
        list: å„ã‚·ãƒ¼ãƒˆã® (ç”»åƒ, é…ç½®ãƒ‡ãƒ¼ã‚¿) ã®ã‚¿ãƒ—ãƒ«ãƒªã‚¹ãƒˆã€‚
    """
    sheet_data = []

    # å„ã‚·ãƒ¼ãƒˆã®ç›®æ¨™ãƒ”ã‚¯ã‚»ãƒ«ã‚µã‚¤ã‚ºã‚’è¨ˆç®—
    sheet_pixel_width = int((sheet_width_mm / MM_PER_INCH) * target_dpi)
    sheet_pixel_height = int((sheet_height_mm / MM_PER_INCH) * target_dpi)

    if sheet_pixel_width <= 0 or sheet_pixel_height <= 0:
        st.error("æŒ‡å®šã•ã‚ŒãŸã‚·ãƒ¼ãƒˆã‚µã‚¤ã‚ºã¾ãŸã¯DPIãŒå°ã•ã™ãã¾ã™ã€‚ã‚·ãƒ¼ãƒˆã®ãƒ”ã‚¯ã‚»ãƒ«ã‚µã‚¤ã‚ºãŒ0ã¾ãŸã¯è² ã«ãªã‚Šã¾ã™ã€‚")
        return []

    # ä½™ç™½ã®ãƒ”ã‚¯ã‚»ãƒ«ã‚µã‚¤ã‚ºã‚’è¨ˆç®—
    margin_top_px = int((margin_top_mm / MM_PER_INCH) * target_dpi)
    margin_bottom_px = int((margin_bottom_mm / MM_PER_INCH) * target_dpi)
    margin_left_px = int((margin_left_mm / MM_PER_INCH) * target_dpi)
    margin_right_px = int((margin_right_mm / MM_PER_INCH) * target_dpi)

    # ãƒ¢ã‚¶ã‚¤ã‚¯ã‚¢ãƒ¼ãƒˆãŒå®Ÿéš›ã«æç”»ã•ã‚Œã‚‹é ˜åŸŸã®ãƒ”ã‚¯ã‚»ãƒ«ã‚µã‚¤ã‚º
    drawable_width_px = sheet_pixel_width - margin_left_px - margin_right_px
    drawable_height_px = sheet_pixel_height - margin_top_px - margin_bottom_px

    if drawable_width_px <= 0 or drawable_height_px <= 0:
        st.error("ä½™ç™½ãŒå¤§ãã™ãã¦ãƒ¢ã‚¶ã‚¤ã‚¯ã‚¢ãƒ¼ãƒˆã‚’æç”»ã™ã‚‹ã‚¹ãƒšãƒ¼ã‚¹ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ä½™ç™½ã‚’æ¸›ã‚‰ã™ã‹ã€ã‚·ãƒ¼ãƒˆã‚µã‚¤ã‚ºã‚’å¤§ããã—ã¦ãã ã•ã„ã€‚")
        return []

    # å…¨ä½“ãƒ¢ã‚¶ã‚¤ã‚¯ã‚¢ãƒ¼ãƒˆã®ç›®æ¨™ãƒ”ã‚¯ã‚»ãƒ«ã‚µã‚¤ã‚º (æç”»å¯èƒ½é ˜åŸŸã®ç·å’Œ)
    total_mosaic_pixel_width = drawable_width_px * num_sheets_horizontal
    total_mosaic_pixel_height = drawable_height_px * num_sheets_vertical

    # full_mosaic_image ã‚’ã€ã“ã® total_mosaic_pixel_width x total_mosaic_pixel_height ã«ãƒªã‚µã‚¤ã‚ºã—ç›´ã™
    resized_full_mosaic_image = full_mosaic_image.resize(
        (total_mosaic_pixel_width, total_mosaic_pixel_height), Image.LANCZOS
    )

    # ã“ã“ã§ã€session_stateã‹ã‚‰å…¨ä½“ã®ãƒ¢ã‚¶ã‚¤ã‚¯ç·æ•°ã‚’å–å¾—ã™ã‚‹ã®ã§ã¯ãªãã€
    # å‘¼ã³å‡ºã—å…ƒã§è¨ˆç®—ã•ã‚ŒãŸå…¨ä½“ã®ãƒ¢ã‚¶ã‚¤ã‚¯ç·æ•°ã‚’ä½¿ç”¨ã™ã‚‹ã‚ˆã†ã«å¤‰æ›´
    mosaic_grid_rows = st.session_state.total_vertical_mosaics # æ–°ã—ãè¿½åŠ 
    mosaic_grid_cols = st.session_state.total_horizontal_mosaics # æ–°ã—ãè¿½åŠ 

    # å„ã‚·ãƒ¼ãƒˆãŒå«ã‚€ãƒ¢ã‚¶ã‚¤ã‚¯ã®ã‚°ãƒªãƒƒãƒ‰æ•°ã‚’è¨ˆç®—
    mosaics_per_sheet_horizontal = mosaic_grid_cols // num_sheets_horizontal
    mosaics_per_sheet_vertical = mosaic_grid_rows // num_sheets_vertical

    if mosaics_per_sheet_horizontal == 0 or mosaics_per_sheet_vertical == 0:
        st.error("ã‚·ãƒ¼ãƒˆã‚ãŸã‚Šã®ãƒ¢ã‚¶ã‚¤ã‚¯æ•°ãŒå°‘ãªã™ãã¾ã™ã€‚ã‚·ãƒ¼ãƒˆåˆ†å‰²æ•°ã‚’æ¸›ã‚‰ã™ã‹ã€ãƒ¢ã‚¶ã‚¤ã‚¯æ•°ã‚’å¢—ã‚„ã—ã¦ãã ã•ã„ã€‚")
        return []

    # å„ãƒ¢ã‚¶ã‚¤ã‚¯ãƒã‚¹ç›®1ã¤ã‚ãŸã‚Šã®ãƒ”ã‚¯ã‚»ãƒ«ã‚µã‚¤ã‚º (ã‚·ãƒ¼ãƒˆå†…ã®æç”»å¯èƒ½é ˜åŸŸã§ã®ã‚µã‚¤ã‚º)
    mosaic_cell_pixel_width_on_sheet = drawable_width_px // mosaics_per_sheet_horizontal
    mosaic_cell_pixel_height_on_sheet = drawable_height_px // mosaics_per_sheet_vertical

    if mosaic_cell_pixel_width_on_sheet <= 0 or mosaic_cell_pixel_height_on_sheet <= 0:
        st.error("å€‹ã€…ã®ãƒ¢ã‚¶ã‚¤ã‚¯ãƒã‚¹ç›®ãŒå°ã•ã™ãã¾ã™ï¼ˆä½™ç™½ãŒå¤šã™ãã‚‹å¯èƒ½æ€§ï¼‰ã€‚ã‚·ãƒ¼ãƒˆã‚µã‚¤ã‚ºã‚’å¤§ããã™ã‚‹ã‹ã€ãƒ¢ã‚¶ã‚¤ã‚¯æ•°ã‚’æ¸›ã‚‰ã—ã¦ãã ã•ã„ã€‚")
        return []

    # ãƒ•ã‚©ãƒ³ãƒˆã®æº–å‚™
    try:
        font_size = max(10, min(20, int(min(mosaic_cell_pixel_width_on_sheet, mosaic_cell_pixel_height_on_sheet) * 0.4)))
        font = ImageFont.truetype("arial.ttf", font_size)
    except IOError:
        font = ImageFont.load_default()
        font_size = 14

    sheet_count = 0
    for sheet_row in range(num_sheets_vertical):
        for sheet_col in range(num_sheets_horizontal):
            sheet_count += 1

            # æ–°ã—ã„ã‚·ãƒ¼ãƒˆç”»åƒã‚’ä½œæˆ (ä½™ç™½ã‚’å«ã‚€å…¨ä½“ã®ãƒ”ã‚¯ã‚»ãƒ«ã‚µã‚¤ã‚ºã§)
            sheet_image = Image.new("RGB", (sheet_pixel_width, sheet_pixel_height), (255, 255, 255)) # ä½™ç™½ã¯ç™½ã§å¡—ã‚Šã¤ã¶ã—
            draw = ImageDraw.Draw(sheet_image)

            # ã“ã®ã‚·ãƒ¼ãƒˆã«å¯¾å¿œã™ã‚‹ã€ãƒªã‚µã‚¤ã‚ºã•ã‚ŒãŸå…¨ä½“ç”»åƒã‹ã‚‰ã®åˆ‡ã‚Šå‡ºã—é ˜åŸŸã‚’æ±ºå®š
            left_crop_overall_image = sheet_col * drawable_width_px
            top_crop_overall_image = sheet_row * drawable_height_px
            right_crop_overall_image = left_crop_overall_image + drawable_width_px
            bottom_crop_overall_image = top_crop_overall_image + drawable_height_px

            # å…¨ä½“ç”»åƒã‹ã‚‰ãƒ¢ã‚¶ã‚¤ã‚¯ã‚¢ãƒ¼ãƒˆéƒ¨åˆ†ã‚’åˆ‡ã‚Šå‡ºã™
            mosaic_art_segment = resized_full_mosaic_image.crop(
                (left_crop_overall_image, top_crop_overall_image, right_crop_overall_image, bottom_crop_overall_image)
            )

            # åˆ‡ã‚Šå‡ºã—ãŸãƒ¢ã‚¶ã‚¤ã‚¯ã‚¢ãƒ¼ãƒˆéƒ¨åˆ†ã‚’ã€ã‚·ãƒ¼ãƒˆç”»åƒã®ä½™ç™½å†…å´ã«è²¼ã‚Šä»˜ã‘
            sheet_image.paste(mosaic_art_segment, (margin_left_px, margin_top_px))

            # ã‚·ãƒ¼ãƒˆç•ªå·ã‚’ç”»åƒã«æ›¸ãè¾¼ã‚€ (ä½ç½®ã‚’èª¿æ•´)
            text_sheet_num = f"Sheet {sheet_count}"
            text_bbox_sheet = draw.textbbox((0,0), text_sheet_num, font=font)
            text_width_sheet = text_bbox_sheet[2] - text_bbox_sheet[0]
            draw.text((sheet_image.width - text_width_sheet - 10, 5), text_sheet_num, font=font, fill=(0, 0, 0))

            # ã‚·ãƒ¼ãƒˆã®é…ç½®ãƒ‡ãƒ¼ã‚¿ãƒ˜ãƒƒãƒ€ãƒ¼
            sheet_placement_data = [full_placement_data[0]]

            # å…¨ä½“é…ç½®ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ã“ã®ã‚·ãƒ¼ãƒˆã®ç¯„å›²å†…ã®ãƒ¢ã‚¶ã‚¤ã‚¯ã‚’æŠ½å‡º
            for row_data in full_placement_data[1:]: # ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã‚’ã‚¹ã‚­ãƒƒãƒ—
                mosaic_overall_row = row_data[0] # å…¨ä½“ã§ã®è¡Œç•ªå· (1-based)
                mosaic_overall_col = row_data[1] # å…¨ä½“ã§ã®åˆ—ç•ªå· (1-based)
                color_index = row_data[2]
                color_name = row_data[3]
                color_rgb = row_data[4]

                # ã“ã®ã‚·ãƒ¼ãƒˆã«å«ã¾ã‚Œã‚‹ãƒ¢ã‚¶ã‚¤ã‚¯ã‹ã©ã†ã‹ã‚’åˆ¤å®š
                start_mosaic_overall_row_idx = sheet_row * mosaics_per_sheet_vertical + 1
                end_mosaic_overall_row_idx = start_mosaic_overall_row_idx + mosaics_per_sheet_vertical - 1
                start_mosaic_overall_col_idx = sheet_col * mosaics_per_sheet_horizontal + 1
                end_mosaic_overall_col_idx = start_mosaic_overall_col_idx + mosaics_per_sheet_horizontal - 1

                if (start_mosaic_overall_row_idx <= mosaic_overall_row <= end_mosaic_overall_row_idx and
                    start_mosaic_overall_col_idx <= mosaic_overall_col <= end_mosaic_overall_col_idx):

                    # ã‚·ãƒ¼ãƒˆå†…ã§ã®ç›¸å¯¾çš„ãªè¡Œã¨åˆ—ã‚’è¨ˆç®— (1-based)
                    relative_row = mosaic_overall_row - start_mosaic_overall_row_idx + 1
                    relative_col = mosaic_overall_col - start_mosaic_overall_col_idx + 1

                    # ã‚·ãƒ¼ãƒˆã®é…ç½®ãƒ‡ãƒ¼ã‚¿ã«è¿½åŠ 
                    sheet_placement_data.append([relative_row, relative_col, color_index, color_name, color_rgb])

                    # å„ãƒã‚¹ç›®ã«ãƒ†ã‚­ã‚¹ãƒˆã‚’æç”» (ä½™ç™½ã‚’è€ƒæ…®ã—ãŸä½ç½®)
                    cell_left_on_sheet_drawable = (relative_col - 1) * mosaic_cell_pixel_width_on_sheet
                    cell_top_on_sheet_drawable = (relative_row - 1) * mosaic_cell_pixel_height_on_sheet

                    # ã‚·ãƒ¼ãƒˆå…¨ä½“åº§æ¨™ã§ã®ãƒ†ã‚­ã‚¹ãƒˆæç”»ä½ç½®
                    text_x_on_sheet = margin_left_px + cell_left_on_sheet_drawable + mosaic_cell_pixel_width_on_sheet // 2
                    text_y_on_sheet = margin_top_px + cell_top_on_sheet_drawable + mosaic_cell_pixel_height_on_sheet // 2

                    # è¡¨ç¤ºã™ã‚‹ãƒ†ã‚­ã‚¹ãƒˆã‚’ã€Œè¡Œ-åˆ—:è‰²åã€ã¾ãŸã¯ã€Œè‰²åã€ã«èª¿æ•´
                    text_to_draw = color_name # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯è‰²å
                    # ãƒã‚¹ç›®ãŒååˆ†ã«åºƒã‘ã‚Œã°è¡Œ-åˆ—ã‚‚è¡¨ç¤º
                    if mosaic_cell_pixel_width_on_sheet >= 80 and mosaic_cell_pixel_height_on_sheet >= 40: # é©å½“ãªé–¾å€¤
                        text_to_draw = f"{relative_row}-{relative_col}:{color_name}"

                    # æ–‡å­—è‰²ã‚’èƒŒæ™¯è‰²ã«å¿œã˜ã¦èª¿æ•´
                    avg_rgb = np.array(color_rgb).mean()
                    text_fill_color = (0, 0, 0) if avg_rgb > 128 else (255, 255, 255)

                    draw.text((text_x_on_sheet, text_y_on_sheet), text_to_draw, fill=text_fill_color, font=font, anchor="mm")

            sheet_data.append((sheet_image, sheet_placement_data, sheet_count))

    return sheet_data

# --- Streamlit ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®UI ---
st.set_page_config(
    page_title="ãƒ¢ã‚¶ã‚¤ã‚¯ã‚¢ãƒ¼ãƒˆè¨ˆç”»ãƒ„ãƒ¼ãƒ«",
    layout="centered",
    initial_sidebar_state="expanded"
)

st.title('ğŸ¨ ãƒ¢ã‚¶ã‚¤ã‚¯ã‚¢ãƒ¼ãƒˆè¨ˆç”»ãƒ„ãƒ¼ãƒ«')
st.write('å…ƒç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã€ã‚«ã‚¹ã‚¿ãƒ ã—ãŸè‰²ã®ã‚·ãƒ¼ãƒ«ã‚’ä½¿ã£ã¦ãƒ¢ã‚¶ã‚¤ã‚¯ã‚¢ãƒ¼ãƒˆã®è¨ˆç”»ã‚’ç«‹ã¦ã¾ã™ã€‚')

with st.sidebar:
    st.header('è¨­å®š')

    # 1. å†™çœŸã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
    st.subheader('å…ƒç”»åƒã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰')
    uploaded_file = st.file_uploader("ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„", type=["jpg", "jpeg", "png"])

    # 2. è‰²ã®æ•°ã¨åå‰ã‚’é¸æŠ
    st.subheader('ä½¿ç”¨ã™ã‚‹ã‚·ãƒ¼ãƒ«ã®è‰²æ•°ã¨åå‰')
    num_colors = st.slider('è‰²ã®æ•°', min_value=2, max_value=10, value=3, step=1)

    sticker_colors_with_names = []
    default_colors_hex = [
        "#FF0000", "#00FF00", "#0000FF", "#FFFF00", "#FF00FF",
        "#00FFFF", "#FFA500", "#800080", "#008000", "#FFC0CB"
    ]
    default_names = ["èµ¤", "ç·‘", "é’", "é»„", "ãƒã‚¼ãƒ³ã‚¿", "ã‚·ã‚¢ãƒ³", "ã‚ªãƒ¬ãƒ³ã‚¸", "ç´«", "æ·±ç·‘", "ãƒ”ãƒ³ã‚¯"]

    for i in range(num_colors):
        col1, col2 = st.columns([0.6, 0.4])
        with col1:
            color_hex = st.color_picker(f'è‰² {i+1} ã‚’é¸ã‚“ã§ãã ã•ã„', default_colors_hex[i % len(default_colors_hex)], key=f'color_picker_{i}')
        with col2:
            color_name = st.text_input(f'è‰² {i+1} ã®åå‰', default_names[i % len(default_names)], key=f'color_name_{i}')

        sticker_colors_with_names.append((hex_to_rgb(color_hex), color_name))

    st.write("é¸æŠã•ã‚ŒãŸè‰²:")
    for i, (rgb, name) in enumerate(sticker_colors_with_names):
        st.write(f"- **{name}**: {rgb}")

    st.session_state['sticker_colors_data'] = sticker_colors_with_names

    # 3. ã‚·ãƒ¼ãƒˆåˆ†å‰²è¨­å®š
    st.subheader('ã‚·ãƒ¼ãƒˆåˆ†å‰²è¨­å®š')
    st.write('ãƒ¢ã‚¶ã‚¤ã‚¯ã‚¢ãƒ¼ãƒˆå…¨ä½“ã‚’ä½•æšã®ã‚·ãƒ¼ãƒˆã«åˆ†å‰²ã—ã¾ã™ã‹ï¼Ÿ')
    num_sheets_horizontal = st.number_input('ã‚·ãƒ¼ãƒˆã®æ¨ªåˆ†å‰²æ•°', min_value=1, value=1, step=1)
    num_sheets_vertical = st.number_input('ã‚·ãƒ¼ãƒˆã®ç¸¦åˆ†å‰²æ•°', min_value=1, value=1, step=1)

    # 4. 1æšã‚ãŸã‚Šã®ãƒ¢ã‚¶ã‚¤ã‚¯æ•°ã‚’æŒ‡å®š (æ–°ã—ã„æ©Ÿèƒ½)
    st.subheader('1æšã‚ãŸã‚Šã®ãƒ¢ã‚¶ã‚¤ã‚¯æ•°')
    st.write('å„ã‚·ãƒ¼ãƒˆã«é…ç½®ã™ã‚‹ãƒ¢ã‚¶ã‚¤ã‚¯ã®æ•°ã‚’æŒ‡å®šã—ã¾ã™ã€‚')
    mosaics_per_sheet_horizontal_input = st.number_input('1æšã‚ãŸã‚Šã®æ¨ªæ–¹å‘ã®ãƒ¢ã‚¶ã‚¤ã‚¯æ•°', min_value=1, value=12, step=1, key='mosaics_per_sheet_horizontal_input')
    mosaics_per_sheet_vertical_input = st.number_input('1æšã‚ãŸã‚Šã®ç¸¦æ–¹å‘ã®ãƒ¢ã‚¶ã‚¤ã‚¯æ•°', min_value=1, value=8, step=1, key='mosaics_per_sheet_vertical_input')

    # 5. ã‚·ãƒ¼ãƒˆä¸€æšã®ã‚µã‚¤ã‚ºã‚’æŒ‡å®š
    st.subheader('ã‚·ãƒ¼ãƒˆä¸€æšã®ç‰©ç†ã‚µã‚¤ã‚º (å°åˆ·æ™‚)')
    st.write('å„ã‚·ãƒ¼ãƒˆãŒå°åˆ·ã•ã‚ŒãŸæ™‚ã®ã‚µã‚¤ã‚ºã‚’æŒ‡å®šã—ã¾ã™ã€‚')
    paper_sizes = {
        "ã‚«ã‚¹ã‚¿ãƒ ": (0, 0),
        "A3 (297 x 420 mm)": (297, 420),
        "A4 (210 x 297 mm)": (210, 297),
        "ãƒ¬ã‚¿ãƒ¼ (215.9 x 279.4 mm)": (215.9, 279.4)
    }
    selected_paper_size_name = st.selectbox("ç”¨ç´™ã‚µã‚¤ã‚ºãƒ—ãƒªã‚»ãƒƒãƒˆ", list(paper_sizes.keys()))

    default_width_mm, default_height_mm = paper_sizes[selected_paper_size_name]

    sheet_width_mm = st.number_input(
        'ã‚·ãƒ¼ãƒˆã®å¹… (mm)',
        min_value=1.0,
        value=float(default_width_mm if default_width_mm != 0 else 297),
        step=1.0
    )
    sheet_height_mm = st.number_input(
        'ã‚·ãƒ¼ãƒˆã®é«˜ã• (mm)',
        min_value=1.0,
        value=float(default_height_mm if default_height_mm != 0 else 420),
        step=1.0
    )

    st.subheader('å°åˆ·æ™‚ã®è§£åƒåº¦ (DPI)')
    target_dpi = st.slider('å°åˆ·æ™‚ã®DPI (è§£åƒåº¦)', min_value=72, max_value=600, value=300, step=10)

    # 6. ä½™ç™½ã®æŒ‡å®š
    st.subheader('ã‚·ãƒ¼ãƒˆã®ä½™ç™½è¨­å®š (mm)')
    st.write('å„ã‚·ãƒ¼ãƒˆã®ä¸Šä¸‹å·¦å³ã®ä½™ç™½ã‚’ãƒŸãƒªãƒ¡ãƒ¼ãƒˆãƒ«ã§æŒ‡å®šã—ã¾ã™ã€‚')
    col_margin1, col_margin2 = st.columns(2)
    with col_margin1:
        margin_top_mm = st.number_input('ä¸Šä½™ç™½ (mm)', min_value=0.0, value=10.0, step=1.0)
        margin_bottom_mm = st.number_input('ä¸‹ä½™ç™½ (mm)', min_value=0.0, value=10.0, step=1.0)
    with col_margin2:
        margin_left_mm = st.number_input('å·¦ä½™ç™½ (mm)', min_value=0.0, value=10.0, step=1.0)
        margin_right_mm = st.number_input('å³ä½™ç™½ (mm)', min_value=0.0, value=10.0, step=1.0)


# ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¨ãƒªã‚¢
if uploaded_file is not None:
    image_bytes = uploaded_file.read()
    original_image = Image.open(io.BytesIO(image_bytes))

    st.subheader('å…ƒç”»åƒ')
    st.image(original_image, caption='ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸå…ƒç”»åƒ', use_column_width=True)

    st.markdown('---')
    st.header('ãƒ¢ã‚¶ã‚¤ã‚¯ã‚¢ãƒ¼ãƒˆç”Ÿæˆ')

    if st.button('ãƒ¢ã‚¶ã‚¤ã‚¯ã‚¢ãƒ¼ãƒˆã‚’ç”Ÿæˆ', type="primary"):
        if original_image and mosaics_per_sheet_horizontal_input > 0 and mosaics_per_sheet_vertical_input > 0:
            # ã“ã“ã§å…¨ä½“ã®ãƒ¢ã‚¶ã‚¤ã‚¯ç·æ•°ã‚’è¨ˆç®—
            total_horizontal_mosaics = mosaics_per_sheet_horizontal_input * num_sheets_horizontal
            total_vertical_mosaics = mosaics_per_sheet_vertical_input * num_sheets_vertical

            # session_stateã«å…¨ä½“ã®ãƒ¢ã‚¶ã‚¤ã‚¯ç·æ•°ã‚’ä¿å­˜
            st.session_state.total_horizontal_mosaics = total_horizontal_mosaics
            st.session_state.total_vertical_mosaics = total_vertical_mosaics

            with st.spinner('å…¨ä½“ãƒ¢ã‚¶ã‚¤ã‚¯ã‚¢ãƒ¼ãƒˆã‚’ç”Ÿæˆä¸­...'):
                full_preview_image, full_placement_data = generate_mosaic_art(
                    original_image,
                    total_horizontal_mosaics, # è¨ˆç®—ã•ã‚ŒãŸå…¨ä½“ã®ãƒ¢ã‚¶ã‚¤ã‚¯ç·æ•°ã‚’æ¸¡ã™
                    total_vertical_mosaics,   # è¨ˆç®—ã•ã‚ŒãŸå…¨ä½“ã®ãƒ¢ã‚¶ã‚¤ã‚¯ç·æ•°ã‚’æ¸¡ã™
                    st.session_state['sticker_colors_data']
                )

                if full_preview_image and full_placement_data:
                    st.success('å…¨ä½“ãƒ¢ã‚¶ã‚¤ã‚¯ã‚¢ãƒ¼ãƒˆç”Ÿæˆå®Œäº†ï¼')
                    st.subheader('å…¨ä½“ã®ãƒ¢ã‚¶ã‚¤ã‚¯ã‚¢ãƒ¼ãƒˆ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼')
                    st.image(full_preview_image, caption='å…¨ä½“ã®ãƒ¢ã‚¶ã‚¤ã‚¯ã‚¢ãƒ¼ãƒˆ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼', use_column_width=True)
                    st.info(f"å…¨ä½“ã®ãƒ¢ã‚¶ã‚¤ã‚¯ç·æ•°: æ¨ª {total_horizontal_mosaics} å€‹ x ç¸¦ {total_vertical_mosaics} å€‹")

                    df_full_placement = pd.DataFrame(full_placement_data[1:], columns=full_placement_data[0])
                    csv_buffer_full = io.StringIO()
                    df_full_placement.to_csv(csv_buffer_full, index=False, encoding='utf-8')
                    st.download_button(
                        label="å…¨ä½“ã®é…ç½®è¨ˆç”»ã‚’CSVã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰",
                        data=csv_buffer_full.getvalue(),
                        file_name="mosaic_placement_plan_full.csv",
                        mime="text/csv",
                    )

                    st.markdown('---')
                    st.header('ã‚·ãƒ¼ãƒˆåˆ†å‰²ã•ã‚ŒãŸãƒ¢ã‚¶ã‚¤ã‚¯ã‚¢ãƒ¼ãƒˆ (å„ãƒã‚¹ç›®ã«æƒ…å ±è¨˜è¼‰)')

                    with st.spinner('ã‚·ãƒ¼ãƒˆã‚’åˆ†å‰²ã—ã€æƒ…å ±è¨˜è¼‰ä¸­...'):
                        sheet_results = split_mosaic_into_sheets(
                            full_preview_image,
                            full_placement_data,
                            num_sheets_horizontal,
                            num_sheets_vertical,
                            sheet_width_mm,
                            sheet_height_mm,
                            target_dpi,
                            margin_top_mm,
                            margin_bottom_mm,
                            margin_left_mm,
                            margin_right_mm
                        )

                    if sheet_results:
                        st.success(f'{len(sheet_results)}æšã®ã‚·ãƒ¼ãƒˆã«åˆ†å‰²ã—ã¾ã—ãŸï¼')
                        st.info(f"å„ã‚·ãƒ¼ãƒˆã®ãƒ”ã‚¯ã‚»ãƒ«ã‚µã‚¤ã‚º: {int((sheet_width_mm / MM_PER_INCH) * target_dpi)}px x {int((sheet_height_mm / MM_PER_INCH) * target_dpi)}px (DPI: {target_dpi})")
                        st.info(f"å„ã‚·ãƒ¼ãƒˆå†…ã®ãƒ¢ã‚¶ã‚¤ã‚¯æç”»å¯èƒ½é ˜åŸŸ: {int(((sheet_width_mm - margin_left_mm - margin_right_mm) / MM_PER_INCH) * target_dpi)}px x {int(((sheet_height_mm - margin_top_mm - margin_bottom_mm) / MM_PER_INCH) * target_dpi)}px")
                        st.info(f"å„ãƒ¢ã‚¶ã‚¤ã‚¯ãƒã‚¹ç›®ã®ãƒ”ã‚¯ã‚»ãƒ«ã‚µã‚¤ã‚º: ç´„{sheet_results[0][0].width / (total_horizontal_mosaics // num_sheets_horizontal)}px x ç´„{sheet_results[0][0].height / (total_vertical_mosaics // num_sheets_vertical)}px")

                        zip_buffer = io.BytesIO()
                        with zipfile.ZipFile(zip_buffer, 'w', zipfile.ZIP_DEFLATED) as zf:
                            for sheet_image, sheet_placement_data, sheet_num in sheet_results:
                                img_byte_arr = io.BytesIO()
                                sheet_image.save(img_byte_arr, format='PNG')
                                zf.writestr(f'sheet_{sheet_num:02d}_preview_labeled.png', img_byte_arr.getvalue())

                                df_sheet_placement = pd.DataFrame(sheet_placement_data[1:], columns=sheet_placement_data[0])
                                csv_buffer_sheet = io.StringIO()
                                df_sheet_placement.to_csv(csv_buffer_sheet, index=False, encoding='utf-8')
                                zf.writestr(f'sheet_{sheet_num:02d}_placement_labeled.csv', csv_buffer_sheet.getvalue())

                                with st.expander(f"ã‚·ãƒ¼ãƒˆ {sheet_num} (æƒ…å ±è¨˜è¼‰ã‚ã‚Š)"):
                                    st.image(sheet_image, caption=f'ã‚·ãƒ¼ãƒˆ {sheet_num} ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ (æƒ…å ±è¨˜è¼‰ã‚ã‚Š)', use_column_width=True)
                                    st.dataframe(df_sheet_placement)

                                    st.download_button(
                                        label=f"ã‚·ãƒ¼ãƒˆ {sheet_num} (æƒ…å ±è¨˜è¼‰ã‚ã‚Š) ã®é…ç½®è¨ˆç”»ã‚’CSVã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰",
                                        data=csv_buffer_sheet.getvalue(),
                                        file_name=f"sheet_{sheet_num:02d}_placement_labeled.csv",
                                        mime="text/csv",
                                    )

                        st.download_button(
                            label="å…¨ã‚·ãƒ¼ãƒˆ (æƒ…å ±è¨˜è¼‰ã‚ã‚Š) ã®ç”»åƒã¨è¨ˆç”»ã‚’ZIPã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰",
                            data=zip_buffer.getvalue(),
                            file_name="mosaic_art_sheets_labeled.zip",
                            mime="application/zip",
                        )

                    else:
                        st.error("ã‚·ãƒ¼ãƒˆã®åˆ†å‰²ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚·ãƒ¼ãƒˆåˆ†å‰²è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚")
                else:
                    st.error("ãƒ¢ã‚¶ã‚¤ã‚¯ã‚¢ãƒ¼ãƒˆã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚")
        else:
            st.warning("ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã€ã™ã¹ã¦ã®è¨­å®šã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚")
else:
    st.info("å·¦å´ã®ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‹ã‚‰ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã€è¨­å®šã‚’è¡Œã£ã¦ãã ã•ã„ã€‚")

st.markdown('---')
st.caption('Â© 2025 ãƒ¢ã‚¶ã‚¤ã‚¯ã‚¢ãƒ¼ãƒˆè¨ˆç”»ãƒ„ãƒ¼ãƒ«')